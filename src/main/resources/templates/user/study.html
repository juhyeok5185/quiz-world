<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="user/layout">

<div layout:fragment="content" class="p-6 space-y-4">
    <div class="flex flex-wrap space-x-4 mb-6 items-center">
        <div class="flex space-x-4 items-center">
            <!-- í† ê¸€ ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="bg-gray-200 p-2 rounded-lg flex space-x-2">
                <div id="toggleAll" onclick="setToggle('all')"
                     class="px-4 py-2 rounded-md transition bg-gradient-to-r from-blue-500 to-indigo-500 text-white cursor-pointer">
                    ì „ì²´
                </div>
                <div id="toggleQuestion" onclick="setToggle('question')"
                     class="px-4 py-2 rounded-md transition bg-gray-300 text-gray-800 cursor-pointer">
                    ë¬¸ì œ
                </div>
                <div id="toggleAnswer" onclick="setToggle('answer')"
                     class="px-4 py-2 rounded-md transition bg-gray-300 text-gray-800 cursor-pointer">
                    ë‹µ
                </div>
            </div>

            <!-- ì…”í”Œ ë²„íŠ¼ (í´ë¦­ ì‹œ ê·¸ë¼ë°ì´ì…˜ í›„ ì›ë˜ ìƒ‰ìƒ ë³µê·€) -->
            <div id="shuffleButton" onclick="shuffleEffect()"
                 class="px-4 py-2 rounded-md transition bg-gray-300 text-gray-800 flex items-center cursor-pointer">
                â‡„
            </div>

            <div class="relative">
                <div id="focusModeButton" onclick="toggleFocusMenu()"
                     class="px-4 py-2 rounded-md transition bg-gray-300 text-gray-800 flex items-center cursor-pointer">
                    â–¶
                </div>

                <!-- ì§‘ì¤‘ëª¨ë“œ ì„ íƒ ë©”ë‰´ (Popover) -->
                <div id="focusModeMenu"
                     class="absolute top-full right-0 mt-2 bg-white shadow-lg rounded-md p-2 hidden flex flex-col w-32 z-50">

                <div onclick="startFocusMode()"
                         class="w-full px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-md cursor-pointer">
                        ì§‘ì¤‘ëª¨ë“œ
                    </div>
                    <div onclick="startFlashMode()"
                         class="w-full px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-md cursor-pointer">
                        ê¹œë¹¡ì´ëª¨ë“œ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ ì˜ì—­ -->
    <div class="listArea grid grid-cols-1 gap-4 mt-4"></div>

    <!-- ë¬¸ì œ ì¶”ê°€ ë²„íŠ¼ -->
    <div onclick="find('#modal-save').classList.remove('hidden')"
         class="fixed bottom-20 right-6 w-14 h-14 bg-gradient-to-r from-blue-500 to-indigo-500
                text-white text-[28px] font-bold rounded-full shadow-xl hover:opacity-90 transition
                flex items-center justify-center cursor-pointer">
        <span class="absolute top-[12px] right-[17.5px] leading-none">+</span>
    </div>

    <!-- ë¬¸ì œ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="modal-save"
         class="fixed inset-0 left-0 top-[-16px] bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 class="text-xl font-bold mb-4">ìƒˆ ë¬¸ì œ ì¶”ê°€</h2>
            <form id="saveForm">
                <select name="type" class="w-full border p-2 rounded mb-4">
                    <option value="WORD">ë‹¨ë‹µí˜•</option>
                </select>
                <input type="text" name="questionText" placeholder="ë¬¸ì œ ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="text" name="answerText" placeholder="ì •ë‹µ ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="text" name="description" placeholder="ì„¤ëª… ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <div class="flex justify-end">
                    <div onclick="find('#modal-save').classList.add('hidden')"
                         class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md mr-2 cursor-pointer">
                        ì·¨ì†Œ
                    </div>
                    <div onclick="saveQuestion()"
                         class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-2 rounded-md hover:opacity-90 transition cursor-pointer">
                        ì €ì¥
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ë¬¸ì œ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="modal-update" class="fixed inset-0 left-0 top-[-16px] bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 class="text-xl font-bold mb-4">ë¬¸ì œ ìˆ˜ì •</h2>
            <form id="updateForm">
                <input type="hidden" id="studyId" name="studyId">
                <select name="type" class="w-full border p-2 rounded mb-4">
                    <option value="WORD">ë‹¨ë‹µí˜•(ì˜ì–´ë‹¨ì–´ì— ì í•©)</option>
                    <option value="DESCRIPTIVE">ì„œìˆ í˜•</option>
                </select>
                <input type="text" id="questionText" name="questionText" placeholder="ë¬¸ì œ ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="text" id="answerText" name="answerText" placeholder="ì •ë‹µ ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="text" id="description" name="description" placeholder="ì„¤ëª… ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <div class="flex justify-end">
                    <div onclick="find('#modal-update').classList.add('hidden')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md mr-2 cursor-pointer">
                        ì·¨ì†Œ
                    </div>
                    <div onclick="updateStudy()"
                         class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-2 rounded-md hover:opacity-90 transition cursor-pointer">
                        ìˆ˜ì •
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="specialModeContainer"
         class="fixed top-[-16px] left-0 w-full h-full bg-white z-[9999] flex items-center justify-center hidden">
        <div class="absolute top-4 left-4">
            <div onclick="closeSpecialMode()" class="text-gray-700 hover:text-gray-900 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </div>
        </div>
        <div id="specialModeContent" class="text-center">
            <div id="specialModeQuestion" class="text-3xl font-bold mb-6"></div>
            <div id="specialModeAnswer" class="text-2xl mt-4 hidden"></div>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        let studys = [];
        let flashInterval = null;
        let currentToggleMode = 'all'; // âœ… í˜„ì¬ í† ê¸€ ìƒíƒœ ì €ì¥
        let activePopoverId = null;



        window.onload = () => {
            findAllByChapterId();
            document.addEventListener("click", closePopoverOnOutsideClick);
        };

        async function saveQuestion() {
            const chapterId = getParamValue('chapterId');
            const formData = new FormData(find('#saveForm'));
            await fetchPostByFormData(`/api/courses/subjects/chapters/${chapterId}/studies`, formData);
            increaseAdCount('postCount')
            location.reload();
        }

        async function findAllByChapterId() {
            const chapterId = getParamValue('chapterId');
            const url = `/api/courses/subjects/chapters/${chapterId}/studies`;
            studys = await fetchGet(url);
            changeLogoText(`${studys[0].chapter.subject.name} - ${studys[0].chapter.name}`)
            drawList();
            increaseAdCount('getCount')
        }

        async function updateStudy() {
            const studyId = find('#studyId').value;
            const formData = new FormData(find('#updateForm'));
            await fetchPatchByFormData(`/api/courses/subjects/chapters/studies/${studyId}`, formData);
            increaseAdCount('updateCount')
            location.reload();
        }

        async function deleteById() {
            const studyId = find('#studyId').value;
            await fetchDelete(`/api/courses/subjects/chapters/studies/${studyId}`);
            location.reload();
        }

        function openSettings(event, studyId) {
            event.stopPropagation(); // ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
            const popover = document.querySelector(`#popover-${studyId}`);
            // í˜„ì¬ ì—´ë¦° popoverì™€ ë™ì¼í•˜ë©´ ë‹«ê¸°
            if (activePopoverId === studyId) {
                popover.classList.add("hidden");
                activePopoverId = null;
            } else {
                // ëª¨ë“  popover ìˆ¨ê¸°ê¸°
                document.querySelectorAll(".popover-menu").forEach(el => el.classList.add("hidden"));

                // í˜„ì¬ í´ë¦­í•œ í†±ë‹ˆë°”í€´ì˜ popover ë³´ì´ê¸°
                popover.classList.remove("hidden");
                activePopoverId = studyId; // í˜„ì¬ ì—´ë¦° popover ID ì €ì¥
            }
        }

        async function updateMode(event, studyId) {
            event.stopPropagation(); // ë¶€ëª¨ div í´ë¦­ ì´ë²¤íŠ¸ ì°¨ë‹¨
            const url = `/api/courses/subjects/chapters/studies/${studyId}`;
            const study = await fetchGet(url);
            find('#studyId').value = study.studyId;
            find('#questionText').value = study.questionText;
            find('#answerText').value = study.answerText;
            find('#description').value = study.description;
            find('#modal-update').classList.remove('hidden');
        }

        function drawList() {
            let html = ``;
            if(studys.length === 0 ) {
                html += `
            <div class="text-center text-gray-500 py-10">
                ë“±ë¡ëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ê³¼ëª©ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”!
            </div>`;
            } else {
                studys.forEach((study, index) => {
                    html += `
                    <div onclick="revealHidden(${index})"
                         class="bg-white shadow-lg rounded-lg p-1 cursor-pointer flex flex-col relative">

                        <!-- í†±ë‹ˆë°”í€´ (ìƒë‹¨ ì—¬ë°± ì™„ì „ ì œê±°) -->
                        <div class="flex justify-end -mt-0.5">
                            <div class="cursor-pointer text-gray-500 hover:text-gray-700 text-xl leading-none"
                                 onclick="openSettings(event, ${study.studyId})">âš™ï¸</div>
                        </div>

                        <!-- ì§ˆë¬¸/ë‹µë³€ (ì—¬ë°± ì™„ì „ ì œê±°) -->
                        <div class="text-sm text-gray-900 text-start break-words space-y-0">
                            <div class="questionText font-normal pb-0"><strong class="text-blue-700">Q.</strong>&nbsp;${study.questionText}</div>
                            <div class="answerText font-normal pt-0"><strong class="text-green-700">A.</strong>&nbsp;${study.answerText}</div>
                        </div>

                        <!-- ì„¤ëª… (ì—¬ë°± ìµœì†Œí™”) -->
                        <div id="hint-${index}" class="descriptionText text-[11px] text-gray-400 hidden">
                            ${study.description || "ì„¤ëª… ì—†ìŒ"}
                        </div>

                        <!-- Popover (ìœ„ì¹˜ ì¡°ì •) -->
                        <div id="popover-${study.studyId}"
                             class="popover-menu absolute right-2 top-6 bg-white border border-gray-200 shadow-sm rounded-sm hidden z-20">
                            <ul class="text-xs space-y-0">
                                <li class="px-2 py-0.5 cursor-pointer hover:bg-gray-50"
                                    onclick="updateMode(event, ${study.studyId})">ìˆ˜ì •</li>
                                <li class="px-2 py-0.5 cursor-pointer hover:bg-red-50 text-red-500"
                                    onclick="deleteById(event, ${study.studyId})">ì‚­ì œ</li>
                            </ul>
                        </div>
                    </div>`;
                });
            }
            find('.listArea').innerHTML = html;
        }



        function revealHidden(index) {
            const questionEl = document.querySelectorAll('.questionText')[index];
            const answerEl = document.querySelectorAll('.answerText')[index];
            const hintEl = document.getElementById(`hint-${index}`);

            if (currentToggleMode === 'question') {
                // ë‹µì´ ë³´ì´ë©´ ìˆ¨ê¸°ê³ , ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ë³´ì´ê²Œ
                answerEl.style.visibility = (answerEl.style.visibility === 'visible') ? 'hidden' : 'visible';
            } else if (currentToggleMode === 'answer') {
                // ì§ˆë¬¸ì´ ë³´ì´ë©´ ìˆ¨ê¸°ê³ , ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ ë³´ì´ê²Œ
                questionEl.style.visibility = (questionEl.style.visibility === 'visible') ? 'hidden' : 'visible';
            } else if (currentToggleMode === 'all') {
                // hint ë¸”ë¡ show/hide toggle
                if (hintEl.classList.contains('hidden')) {
                    hintEl.classList.remove('hidden');
                } else {
                    hintEl.classList.add('hidden');
                }
            }

            increaseAdCount('useModeCount');
        }

        function shuffleQuestions() {
            if (studys.length < 2) return; // ìš”ì†Œê°€ 1ê°œ ì´í•˜ë¼ë©´ ì„ì„ í•„ìš” ì—†ìŒ

            let shuffled;
            let attempt = 0;
            const maxAttempts = 10; // ë™ì¼í•œ ë°°ì—´ ë°©ì§€ë¥¼ ìœ„í•œ ìµœëŒ€ ì‹œë„ íšŸìˆ˜

            do {
                shuffled = [...studys].sort(() => Math.random() - 0.5);
                attempt++;
            } while (JSON.stringify(shuffled) === JSON.stringify(studys) && attempt < maxAttempts);

            studys = shuffled;
            drawList();
            setToggle(currentToggleMode);
            increaseAdCount('useModeCount');
        }

        function setToggle(mode) {
            currentToggleMode = mode;

            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            document.querySelectorAll("div[id^='toggle']").forEach(btn => {
                btn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500', 'text-white');
                btn.classList.add('bg-gray-300', 'text-gray-800');
            });

            // ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©
            document.getElementById(`toggle${mode.charAt(0).toUpperCase() + mode.slice(1)}`)
                .classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500', 'text-white');

            // ì§ˆë¬¸/ë‹µ í‘œì‹œ
            findAll('.questionText').forEach(el => {
                el.style.visibility = (mode === 'answer') ? 'hidden' : 'visible';
            });

            findAll('.answerText').forEach(el => {
                el.style.visibility = (mode === 'question') ? 'hidden' : 'visible';
            });

            // ğŸ’¡ íŒíŠ¸ ìˆ¨ê¸°ê¸° ì²˜ë¦¬
            findAll('.descriptionText').forEach(hint => {
                if (!hint.classList.contains('hidden')) {
                    hint.classList.add('hidden');
                }
            });

            increaseAdCount('useModeCount');
        }

        function shuffleEffect() {
            const shuffleBtn = document.getElementById('shuffleButton');

            // 0.5ì´ˆ ë™ì•ˆ ê·¸ë¼ë°ì´ì…˜ íš¨ê³¼
            shuffleBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500', 'text-white');
            shuffleBtn.classList.remove('bg-gray-300', 'text-gray-800');

            setTimeout(() => {
                shuffleBtn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500', 'text-white');
                shuffleBtn.classList.add('bg-gray-300', 'text-gray-800');
            }, 100);

            shuffleQuestions();

        }

        function toggleFocusMenu() {
            const menu = document.getElementById("focusModeMenu");
            menu.classList.toggle("hidden"); // ë©”ë‰´ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€

            document.removeEventListener("click", closeFocusMenu);
            setTimeout(() => document.addEventListener("click", closeFocusMenu), 0);
        }

        function closeFocusMenu(event) {
            const menu = document.getElementById("focusModeMenu");
            const button = document.getElementById("focusModeButton");

            // ë²„íŠ¼ì´ë‚˜ íŒì˜¤ë²„ ë‚´ë¶€ë¥¼ í´ë¦­í•œ ê²½ìš° ë‹«ì§€ ì•ŠìŒ
            if (menu.contains(event.target) || button.contains(event.target)) return;

            // íŒì˜¤ë²„ ë‹«ê¸°
            menu.classList.add("hidden");

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            document.removeEventListener("click", closeFocusMenu);
        }

        function startFocusMode() {
            if (studys.length === 0) return;

            currentIndex = 0;
            isFocusMode = true;
            isFlashMode = false;
            clearInterval(flashInterval);

            const specialModeContainer = document.getElementById('specialModeContainer');
            const specialModeQuestion = document.getElementById('specialModeQuestion');
            const specialModeAnswer = document.getElementById('specialModeAnswer');

            specialModeContainer.style.display = 'flex';
            updateSpecialModeContent();

            // ì§‘ì¤‘ëª¨ë“œ: í™”ë©´ í„°ì¹˜ì‹œ ë‹¤ìŒ ë‚´ìš© ë³´ì—¬ì£¼ê¸°
            specialModeContainer.onclick = function (event) {
                // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ì‹œì—ëŠ” ì´ë²¤íŠ¸ ì²˜ë¦¬ ì•ˆí•¨
                if (event.target.closest('button')) return;

                if (specialModeAnswer.style.display === 'none') {
                    // ë‹µë³€ ë³´ì—¬ì£¼ê¸°
                    specialModeAnswer.style.display = 'block';
                } else {
                    // ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
                    currentIndex = (currentIndex + 1) % studys.length;
                    updateSpecialModeContent();
                }
            };

            increaseAdCount('useModeCount');

        }

        function startFlashMode() {
            if (studys.length === 0) return;

            currentIndex = 0;
            isFocusMode = false;
            isFlashMode = true;

            const specialModeContainer = document.getElementById('specialModeContainer');
            specialModeContainer.style.display = 'flex';

            // ê¹œë¹¡ì´ëª¨ë“œëŠ” í´ë¦­ ì´ë²¤íŠ¸ ì œê±° (ìë™ìœ¼ë¡œ ë„˜ì–´ê°€ë¯€ë¡œ)
            specialModeContainer.onclick = function (event) {
                // ë‹«ê¸° ë²„íŠ¼ë§Œ ì‘ë™í•˜ë„ë¡
                if (!event.target.closest('button')) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            };

            updateSpecialModeContent();

            // 5ì´ˆë§ˆë‹¤ ë‹¤ìŒ ë‚´ìš©ìœ¼ë¡œ ë„˜ì–´ê°€ê¸°
            clearInterval(flashInterval);
            flashInterval = setInterval(() => {
                currentIndex = (currentIndex + 1) % studys.length;
                updateSpecialModeContent();
            }, 3000);

            increaseAdCount('useModeCount');
        }

        function closeSpecialMode() {
            const specialModeContainer = document.getElementById('specialModeContainer');
            specialModeContainer.style.display = 'none';

            // ëª¨ë“œ í•´ì œ
            isFocusMode = false;
            isFlashMode = false;
            clearInterval(flashInterval);
        }

        function updateSpecialModeContent() {
            if (studys.length === 0) return;

            const currentQuestion = studys[currentIndex];
            const specialModeQuestion = document.getElementById('specialModeQuestion');
            const specialModeAnswer = document.getElementById('specialModeAnswer');

            // ì§ˆë¬¸ ì„¤ì •
            specialModeQuestion.textContent = currentQuestion.questionText;

            // ë‹µë³€ ì„¤ì • (ì²« ë²ˆì§¸ ë‹µë³€ ì‚¬ìš©)
            specialModeAnswer.textContent = currentQuestion.answerText;

            // ê¹œë¹¡ì´ëª¨ë“œì—ì„œëŠ” í•­ìƒ ë‹µë³€ í‘œì‹œ, ì§‘ì¤‘ëª¨ë“œì—ì„œëŠ” ì´ˆê¸°ì— ìˆ¨ê¹€
            if (isFlashMode) {
                specialModeAnswer.style.display = 'block';
            } else {
                specialModeAnswer.style.display = 'none';
            }
        }

        function closePopoverOnOutsideClick(event) {
            if (!event.target.closest(".popover-menu") && !event.target.closest(".text-xl")) {
                document.querySelectorAll(".popover-menu").forEach(el => el.classList.add("hidden"));
                activePopoverId = null;
            }
        }

    </script>
</th:block>
</html>
