<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="user/layout">

<div layout:fragment="content" class="p-6 space-y-4">
    <div class="flex flex-wrap space-x-4 mb-6 items-center">
        <div class="flex space-x-4 items-center">
            <!-- í† ê¸€ ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="bg-gray-200 p-2 rounded-lg flex space-x-2">
                <button id="toggleAll" onclick="setToggle('all')"
                        class="px-4 py-2 rounded-md transition bg-gradient-to-r from-blue-500 to-indigo-500 text-white">
                    ì „ì²´
                </button>
                <button id="toggleQuestion" onclick="setToggle('question')"
                        class="px-4 py-2 rounded-md transition bg-gray-300 text-gray-800">ë¬¸ì œ
                </button>
                <button id="toggleAnswer" onclick="setToggle('answer')"
                        class="px-4 py-2 rounded-md transition bg-gray-300 text-gray-800">ë‹µ
                </button>
            </div>

            <!-- ì…”í”Œ ë²„íŠ¼ (í´ë¦­ ì‹œ ê·¸ë¼ë°ì´ì…˜ í›„ ì›ë˜ ìƒ‰ìƒ ë³µê·€) -->
            <button id="shuffleButton" onclick="shuffleEffect()"
                    class="px-4 py-2 rounded-md transition bg-gray-300 text-gray-800 flex items-center">
                ğŸ”€
            </button>

            <div class="relative">
                <button id="focusModeButton" onclick="toggleFocusMenu()"
                        class="px-4 py-2 rounded-md transition bg-gray-300 text-gray-800 flex items-center">
                    â–¶
                </button>

                <!-- ì§‘ì¤‘ëª¨ë“œ ì„ íƒ ë©”ë‰´ (Popover) -->
                <div id="focusModeMenu"
                     class="absolute top-full right-0 mt-2 bg-white shadow-lg rounded-md p-2 hidden flex flex-col w-32">
                    <button onclick="startFocusMode()"
                            class="w-full px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-md">
                        ì§‘ì¤‘ëª¨ë“œ
                    </button>
                    <button onclick="startFlashMode()"
                            class="w-full px-4 py-2 text-gray-800 hover:bg-gray-200 rounded-md">
                        ê¹œë¹¡ì´ëª¨ë“œ
                    </button>
                </div>


            </div>

        </div>

    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ ì˜ì—­ -->
    <div class="listArea grid grid-cols-1 gap-4 mt-4"></div>

    <!-- ë¬¸ì œ ì¶”ê°€ ë²„íŠ¼ -->
    <button onclick="find('#modal-save').classList.remove('hidden')"
            class="fixed bottom-20 right-6 w-14 h-14 bg-gradient-to-r from-blue-500 to-indigo-500
                   text-white text-[28px] font-bold rounded-full shadow-xl hover:opacity-90 transition
                   flex items-center justify-center">
        <span class="absolute top-[12px] right-[17.5px] leading-none">+</span>
    </button>

    <!-- ë¬¸ì œ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="modal-save" class="fixed inset-0 left-0 top-[-16px] bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 class="text-xl font-bold mb-4">ìƒˆ ë¬¸ì œ ì¶”ê°€</h2>
            <form id="saveForm">
                <select name="questionRequest.type" class="w-full border p-2 rounded mb-4">
                    <option value="SHORT">ë‹¨ë‹µí˜•(ì˜ì–´ë‹¨ì–´ì— ì í•©)</option>
                </select>
                <input type="text" name="questionRequest.questionText" placeholder="ë¬¸ì œ ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="text" name="answerRequest[0].answerText" placeholder="ì •ë‹µ ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="text" name="questionRequest.description" placeholder="ì„¤ëª… ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="hidden" name="answerRequest[0].answerYn" value="true">
                <div class="flex justify-end">
                    <button type="button" onclick="find('#modal-save').classList.add('hidden')"
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md mr-2">ì·¨ì†Œ
                    </button>
                    <button type="button" onclick="saveQuestion()"
                            class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-2 rounded-md hover:opacity-90 transition">
                        ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë¬¸ì œ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="modal-update" class="fixed inset-0 left-0 top-[-16px] bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 class="text-xl font-bold mb-4">ë¬¸ì œ ìˆ˜ì •</h2>
            <form id="updateForm">
                <input type="hidden" id="questionId" name="questionId">
                <select name="questionRequest.type" class="w-full border p-2 rounded mb-4">
                    <option value="SHORT">ë‹¨ë‹µí˜•(ì˜ì–´ë‹¨ì–´ì— ì í•©)</option>
                </select>
                <input type="text" id="questionText" name="questionRequest.questionText" placeholder="ë¬¸ì œ ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="text" id="answerText" name="answerRequest[0].answerText" placeholder="ì •ë‹µ ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="text" id="description" name="questionRequest.description" placeholder="ì„¤ëª… ì…ë ¥"
                       class="w-full border p-2 rounded mb-4">
                <input type="hidden" name="answerRequest[0].answerYn" value="true">
                <div class="flex justify-end">
                    <button type="button" onclick="find('#modal-update').classList.add('hidden')"
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md mr-2">ì·¨ì†Œ
                    </button>
                    <button type="button" onclick="updateQuestion()"
                            class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-2 rounded-md hover:opacity-90 transition">
                        ìˆ˜ì •
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div id="specialModeContainer"
         class="fixed top-[-16px] left-0 w-full h-full bg-white z-[9999] flex items-center justify-center hidden">
        <div class="absolute top-4 left-4">
            <button onclick="closeSpecialMode()" class="text-gray-700 hover:text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div id="specialModeContent" class="text-center">
            <div id="specialModeQuestion" class="text-3xl font-bold mb-6"></div>
            <div id="specialModeAnswer" class="text-2xl mt-4 hidden"></div>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        let questions = [];
        let hiddenState = {question: false, answer: false};
        let flashInterval = null;


        window.onload = () => {
            findAllByChapterId();
        };

        async function findAllByChapterId() {
            const chapterId = getParamValue('chapterId');
            const url = `/api/questions/chapters/${chapterId}`;
            questions = await fetchGet(url);
            changeLogoText(`${questions[0].question.chapter.subject.name} - ${questions[0].question.chapter.name}`)
            drawList();
        }

        function drawList() {
            let html = ``;
            questions.forEach((questionData, index) => {
                html += `
                          <div class="bg-white shadow-lg rounded-lg p-4 cursor-pointer flex flex-col"
                              onclick="toggleHint(${index})" data-index="${index}">
                              <div class="flex justify-between items-center">
                                  <span class="questionText font-semibold text-gray-900 text-left flex-1">${questionData.question.questionText}</span>
                                  <span class="answerText text-gray-700 text-right flex-1">${questionData.answer[0].answerText}</span>
                              </div>
                              <div id="hint-${index}" class="descriptionText mt-2 text-sm text-gray-600 italic hidden">
                                  ${questionData.question.description || "ì„¤ëª… ì—†ìŒ"}
                              </div>
                          </div>
                        `;
            });
            find('.listArea').innerHTML = html;
        }


        function toggleHint(index) {
            const hintElement = document.getElementById(`hint-${index}`);
            if (hintElement) {
                hintElement.classList.toggle('hidden');
            }
        }

        function shuffleQuestions() {
            questions = questions.sort(() => Math.random() - 0.5);
            drawList();
        }

        async function saveQuestion() {
            const chapterId = getParamValue('chapterId');
            const formData = new FormData(find('#saveForm'));
            await fetchPostByFormData(`/api/questions/chapters/${chapterId}`, formData);
            location.reload();
        }

        async function updateQuestion() {
            const questionId = find('#questionId').value;
            const formData = new FormData(find('#updateForm'));
            await fetchPatchByFormData(`/api/questions/${questionId}`, formData);
            location.reload();
        }

        async function deleteByQuestionId(questionId) {
            await fetchDelete(`/api/questions/${questionId}`);
            findAllByChapterId();
        }

        async function updateMode(questionId) {
            const response = await fetchGet(`/api/questions/${questionId}`);
            find('#questionId').value = response.question.questionId;
            find('#questionText').value = response.question.questionText;
            find('#answerText').value = response.answer[0].answerText;
            find('#description').value = response.question.description;
            find('#modal-update').classList.remove('hidden');
        }

        function setToggle(mode) {
            // ëª¨ë“  ë²„íŠ¼ ì´ˆê¸°í™”
            document.querySelectorAll("button[id^='toggle']").forEach(btn => {
                btn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500', 'text-white');
                btn.classList.add('bg-gray-300', 'text-gray-800');
            });

            // ì„ íƒëœ ë²„íŠ¼ì— ê·¸ë¼ë°ì´ì…˜ ì ìš©
            document.getElementById(`toggle${mode.charAt(0).toUpperCase() + mode.slice(1)}`)
                .classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500', 'text-white');

            // ë¬¸ì œ/ë‹µ í‘œì‹œ ë¡œì§ (ì „ì²´, ë¬¸ì œ, ë‹µ)
            if (mode === 'all') {
                findAll('.questionText').forEach(el => el.classList.remove('hidden'));
                findAll('.answerText').forEach(el => el.classList.remove('hidden'));
            } else if (mode === 'question') {
                findAll('.questionText').forEach(el => el.classList.remove('hidden'));
                findAll('.answerText').forEach(el => el.classList.add('hidden'));
            } else if (mode === 'answer') {
                findAll('.questionText').forEach(el => el.classList.add('hidden'));
                findAll('.answerText').forEach(el => el.classList.remove('hidden'));
            }
        }

        function shuffleEffect() {
            const shuffleBtn = document.getElementById('shuffleButton');

            // 0.5ì´ˆ ë™ì•ˆ ê·¸ë¼ë°ì´ì…˜ ì ìš©
            shuffleBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500', 'text-white');
            shuffleBtn.classList.remove('bg-gray-300', 'text-gray-800');

            // 0.5ì´ˆ í›„ ì›ë˜ ìƒ‰ìƒìœ¼ë¡œ ë³µê·€
            setTimeout(() => {
                shuffleBtn.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-500', 'text-white');
                shuffleBtn.classList.add('bg-gray-300', 'text-gray-800');
            }, 100);

            // ì…”í”Œ ì‹¤í–‰
            shuffleQuestions();
        }

        function toggleFocusMenu() {
            const menu = document.getElementById("focusModeMenu");
            menu.classList.toggle("hidden"); // ë©”ë‰´ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€

            document.removeEventListener("click", closeFocusMenu);
            setTimeout(() => document.addEventListener("click", closeFocusMenu), 0);
        }

        function closeFocusMenu(event) {
            const menu = document.getElementById("focusModeMenu");
            const button = document.getElementById("focusModeButton");

            // ë²„íŠ¼ì´ë‚˜ íŒì˜¤ë²„ ë‚´ë¶€ë¥¼ í´ë¦­í•œ ê²½ìš° ë‹«ì§€ ì•ŠìŒ
            if (menu.contains(event.target) || button.contains(event.target)) return;

            // íŒì˜¤ë²„ ë‹«ê¸°
            menu.classList.add("hidden");

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            document.removeEventListener("click", closeFocusMenu);
        }

        function startFocusMode() {
            if (questions.length === 0) return;

            currentIndex = 0;
            isFocusMode = true;
            isFlashMode = false;
            clearInterval(flashInterval);

            const specialModeContainer = document.getElementById('specialModeContainer');
            const specialModeQuestion = document.getElementById('specialModeQuestion');
            const specialModeAnswer = document.getElementById('specialModeAnswer');

            specialModeContainer.style.display = 'flex';
            updateSpecialModeContent();

            // ì§‘ì¤‘ëª¨ë“œ: í™”ë©´ í„°ì¹˜ì‹œ ë‹¤ìŒ ë‚´ìš© ë³´ì—¬ì£¼ê¸°
            specialModeContainer.onclick = function (event) {
                // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ì‹œì—ëŠ” ì´ë²¤íŠ¸ ì²˜ë¦¬ ì•ˆí•¨
                if (event.target.closest('button')) return;

                if (specialModeAnswer.style.display === 'none') {
                    // ë‹µë³€ ë³´ì—¬ì£¼ê¸°
                    specialModeAnswer.style.display = 'block';
                } else {
                    // ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
                    currentIndex = (currentIndex + 1) % questions.length;
                    updateSpecialModeContent();
                }
            };
        }

        // ê¹œë¹¡ì´ëª¨ë“œ ì‹¤í–‰ í•¨ìˆ˜ (ì„ì‹œ ë¡œì§)
        function startFlashMode() {
            if (questions.length === 0) return;

            currentIndex = 0;
            isFocusMode = false;
            isFlashMode = true;

            const specialModeContainer = document.getElementById('specialModeContainer');
            specialModeContainer.style.display = 'flex';

            // ê¹œë¹¡ì´ëª¨ë“œëŠ” í´ë¦­ ì´ë²¤íŠ¸ ì œê±° (ìë™ìœ¼ë¡œ ë„˜ì–´ê°€ë¯€ë¡œ)
            specialModeContainer.onclick = function (event) {
                // ë‹«ê¸° ë²„íŠ¼ë§Œ ì‘ë™í•˜ë„ë¡
                if (!event.target.closest('button')) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            };

            updateSpecialModeContent();

            // 5ì´ˆë§ˆë‹¤ ë‹¤ìŒ ë‚´ìš©ìœ¼ë¡œ ë„˜ì–´ê°€ê¸°
            clearInterval(flashInterval);
            flashInterval = setInterval(() => {
                currentIndex = (currentIndex + 1) % questions.length;
                updateSpecialModeContent();
            }, 3000);
        }

        function closeSpecialMode() {
            const specialModeContainer = document.getElementById('specialModeContainer');
            specialModeContainer.style.display = 'none';

            // ëª¨ë“œ í•´ì œ
            isFocusMode = false;
            isFlashMode = false;
            clearInterval(flashInterval);
        }

        function updateSpecialModeContent() {
            if (questions.length === 0) return;

            const currentQuestion = questions[currentIndex];
            const specialModeQuestion = document.getElementById('specialModeQuestion');
            const specialModeAnswer = document.getElementById('specialModeAnswer');

            // ì§ˆë¬¸ ì„¤ì •
            specialModeQuestion.textContent = currentQuestion.question.questionText;

            // ë‹µë³€ ì„¤ì • (ì²« ë²ˆì§¸ ë‹µë³€ ì‚¬ìš©)
            let answerText = "";
            if (currentQuestion.answer && currentQuestion.answer.length > 0) {
                answerText = currentQuestion.answer[0].answerText;
            }
            specialModeAnswer.textContent = answerText;

            // ê¹œë¹¡ì´ëª¨ë“œì—ì„œëŠ” í•­ìƒ ë‹µë³€ í‘œì‹œ, ì§‘ì¤‘ëª¨ë“œì—ì„œëŠ” ì´ˆê¸°ì— ìˆ¨ê¹€
            if (isFlashMode) {
                specialModeAnswer.style.display = 'block';
            } else {
                specialModeAnswer.style.display = 'none';
            }
        }

    </script>
</th:block>

</html>
