<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="user/layout">
<div layout:fragment="content" class="p-4 space-y-6 w-full md:max-w-screen-md md:mx-auto">

    <!-- 사용자 정보 및 점수 -->
    <div id="userInfo" class="bg-white p-6 rounded-lg shadow-md flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h2 class="text-xl font-bold nickname"></h2>
        </div>
        <div class="text-right">
            <p class="text-gray-500 text-sm">이번 달 점수: <span class="text-blue-500 font-semibold score"></span></p>
            <p class="text-sm prevScoreInfo"></p>
        </div>
    </div>

    <!-- 점수 추이 그래프 -->
    <div class="bg-white p-4 border rounded-lg shadow-md">
        <canvas id="scoreChart"></canvas>
    </div>

    <!-- 3가지 데이터를 가로로 표시 -->
    <div class="flex bg-white p-4 border rounded-lg shadow-md divide-x divide-gray-300">
        <div class="flex-1 text-center">
            <p class="text-xl font-bold">나의 과목</p>
            <p class="text-lg font-semibold text-gray-500 mySubjectCount"></p>
        </div>
        <div class="flex-1 text-center">
            <p class="text-xl font-bold">나의 퀴즈</p>
            <p class="text-lg font-semibold text-gray-500 myStudyCount"></p>
        </div>
        <div class="flex-1 text-center">
            <p class="text-xl font-bold">수강중</p>
            <p class="text-lg font-semibold text-gray-500 enrolledSubjectCount"></p>
        </div>
    </div>

    <!-- 내 과목 바로가기 -->
    <div class="p-4 bg-white border rounded-lg shadow-md hover:bg-gray-100 transition cursor-pointer"
         onclick="location.href='/user/subject'">
        <p class="text-lg font-semibold text-gray-700">내 과목 바로가기</p>
    </div>

    <!-- 과목 검색하기 -->
    <div class="p-4 bg-white border rounded-lg shadow-md hover:bg-gray-100 transition cursor-pointer"
         onclick="location.href='/user/search'">
        <p class="text-lg font-semibold text-gray-700">과목 검색하기</p>
    </div>

</div>

<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
        window.onload = function () {
            findMember();
        }

        async function findMember() {
            const url = `/api/members/dashboard`;
            const response = await fetchGet(url);
            drawDashboard(response);
        }

        function drawDashboard(response) {
            const nickname = response.nickname;
            const currentScore = response.score;
            let memberScoreLog = response.memberScoreLog || [];

            // 정렬 (년, 월 순서)
            memberScoreLog.sort((a, b) => (a.year * 100 + a.month) - (b.year * 100 + b.month));

            // nickname 표시
            find('.nickname').textContent = `${nickname}님`;

            // 점수 표시
            find('.score').textContent = `${currentScore}점`;

            // 지난달 점수 가져오기 (마지막 log 기준)
            const lastMonthData = memberScoreLog[memberScoreLog.length - 1];
            const lastMonthScore = lastMonthData ? lastMonthData.score : 0;
            const diff = currentScore - lastMonthScore;
            const diffText = diff >= 0 ? `+${diff}점 상승` : `${diff}점 하락`;
            const diffClass = diff >= 0 ? 'text-green-500' : 'text-red-500';
            find('.prevScoreInfo').innerHTML = `<span class="${diffClass}">지난 달 대비 ${diffText}</span>`;

            // my stat
            find('.mySubjectCount').textContent = `${response.mySubjectCount}개`;
            find('.myStudyCount').textContent = `${response.myStudyCount}개`;
            find('.enrolledSubjectCount').textContent = `${response.enrolledSubjectCount}개`;

            // 그래프 데이터 구성
            const labels = [...memberScoreLog.map(d => `${d.year}.${d.month}`), getCurrentYearMonthStr()];
            const scores = [...memberScoreLog.map(d => d.score), currentScore];
            const pointBackgroundColors = scores.map((_, idx) => idx === scores.length - 1 ? '#ffffff' : '#93C5FD');
            const pointRadius = scores.map((_, idx) => idx === scores.length - 1 ? 6 : 4);
            const pointHoverRadius = scores.map((_, idx) => idx === scores.length - 1 ? 8 : 6);

            // Chart 그리기
            const ctx = document.getElementById('scoreChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '월별 점수 추이',
                        data: scores,
                        borderColor: '#3B82F6',
                        backgroundColor: '#93C5FD',
                        fill: false,
                        tension: 0.3,
                        pointBackgroundColor: pointBackgroundColors,
                        pointRadius: pointRadius,
                        pointHoverRadius: pointHoverRadius,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function getCurrentYearMonthStr() {
            const now = new Date();
            return `${now.getFullYear()}.${now.getMonth() + 1}`;
        }
    </script>
</th:block>
</html>